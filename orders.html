<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title></title>
		<link rel="stylesheet" type="text/css" href="extjs4.2.1/resources/css/ext-all.css">
		<script src="extjs4.2.1/ext-all.js"></script>
		<script src="extjs4.2.1/locale/ext-lang-zh_CN.js"></script>
	</head>
	<body>
		<script>
		Ext.onReady(function(){ 				
				Ext.regModel('ordermodel',{
					//idProperty:'ryxx_id',
					fields:['id','orderno','orderdate','departno','departname','sellername','sellertel','orderstate','ordertype','orderdesc']
				});
				Ext.regModel('detailmodel',{
					fields:['id','orderno','itemno','color','size','num','price','othermsg']
				});	
				

							
				Ext.regModel('ordermodel',{
				   fields:['orderstate']
				});
				var orderstore = new Ext.data.Store({
				   model:'ordermodel',
				   data:[{orderstate:'待配送'},{ordersate:'已发货'}]
				});
				
				Ext.regModel('provinceInfo',{
					fields:[{name:'name'},{name:'id'}]
				});
				
				var provinceStore = Ext.create('Ext.data.Store',{
					model:'provinceInfo',
					data:[]
			
				});
				
				Ext.regModel('cityInfo',{
					fields:[{name:'province'},{name:'name'},{name:'id'}]
				});
				
				
				Ext.regModel('departInfo',{
					fields:[{name:'departname'},{name:'departno'}]
				});
				
				var departStore = Ext.create('Ext.data.Store',{
					model:'departInfo',
					data:[
						{departname:'办公室',departno:'W070'},
						{departname:'工会',departno:'W099'},
						{departname:'企管部',departno:'W071'},
					]
				});
				
				
   
				
				var toolbar = new Ext.toolbar.Toolbar({
					items:[
						 '请输入用户编号',
						 {xtype:'textfield',id:'usernoinput',name:'userno'},						
						 '请输入用户密码',
						 {xtype:'textfield',id:'userpwdinput',name:'userpwd'},							 
						 // {xtype:'labelfield',fieldLabel:'所在部门',id:'departname'},					 
				         {text:'验证用户',handler:function(){
				           var cValue = Ext.getCmp('usernoinput').getValue(); 
						   var cPwd = Ext.getCmp('userpwdinput').getValue(); 	
						   if (cValue == ''|cPwd ==''){
							   Ext.Msg.alert("提示","内容输入不完整");
							   return
						   }
						   var senddata = {userno:cValue,userpwd:cPwd};
						    Ext.Ajax.request({
						        url:'ctl_orders.fsp?proc=getuser',						
						        jsonData:senddata,													  
						        callback:function(options,success,response){						            
									var obj = JSON.parse(response.responseText);
									if (obj.total == 0){
										Ext.Msg.alert("提示","用户信息不正确");
										Ext.getCmp('departname').setValue('')
										Ext.getCmp('sellername').setValue('')
										Ext.getCmp('usertel').setValue('')										
										return
									}
									var username = obj.rows[0].username;
									var departname = obj.rows[0].departname;
									var usertel = obj.rows[0].usertel;
									var departno = obj.rows[0].departno;
									console.log('departname:',obj.rows[0].departname)
									//console.log('username:',username)
									Ext.getCmp('departname').setValue(departname)
									Ext.getCmp('sellername').setValue(username)
									Ext.getCmp('usertel').setValue(usertel)															
						        }
						    })						   
				        }},						
						 '订货部门',
						 {xtype:'textfield',
						  id:'departname',
						  readOnly:true,
						  name:'departname',
						  width:60
						 },
						 '订货人姓名',
						{xtype:'textfield',
						readOnly:true,
						id:'sellername',
						name:'sellername',
						width:50
						},
						'电话',
						{xtype:'textfield',id:'usertel',name:'sellertel',readOnly:true,width:80},
						{xtype:'textfield',id:'departno',name:'departno',hidden:true},	
						{xtype:'textfield',id:'orderno',name:'orderno',hidden:true},
						//{xtype:'textfield',id:'orderdate',name:'orderdate',hidden:true},				 
						{text:'增加订单',handler:add},
						{text:'订单提交',handler:save}
					]
				});
				
				var store = new Ext.data.Store({
					model:'detailmodel',
					autoLoad:true,
					proxy:{
						type:'ajax',
						url:'ctl_orders.fsp?proc=getdetail',
						reader:{
							type:'json',
							root:'rows'
						}
					}
				})
						
				var grid = new Ext.grid.Panel({
					// tbar:[toolbar],
					store:store,
					height:300,
					columns:[
						{header:'货号',dataIndex:'itemno',editor:{xtype:'textfield'}},
						{header:'颜色',dataIndex:'color',editor:{xtype:'textfield'}},
						{header:'尺码',dataIndex:'size',editor:{xtype:'textfield'}},
						{header:'数量',dataIndex:'num',editor:{xtype:'textfield'}},
						{header:'单价',dataIndex:'price',editor:{xtype:'textfield'}},
					],
					plugins:[
						Ext.create('Ext.grid.plugin.CellEditing',{
							clicksToEdit:1
						})
					]
				})	
				
				var form = new Ext.form.Panel({		
					tbar:[toolbar],
					items:[	
						
						{xtype:'container',
						layout:'hbox',
						items:[
							{xtype:'datefield',fielLabel:'订单日期',format:'Y-m-d',width:90,id:'datesel',name:'orderdate'},
							{xtype:'textfield',fieldLabel:'收货人姓名',name:'receiver'},
							{xtype:'textfield',fieldLabel:'收货人地址',name:'recaddress'},
							{xtype:'textfield',fieldLabel:'收货人电话',name:'receivertel'}						
						]}						
					]
				})	
				var panel = new Ext.panel.Panel({
					items:[
						form,
						
						grid]
				})
				var viewport = new Ext.container.Viewport({
					items:[panel]
				})
				
				//新增订单
				function add(){
					/*先要形成订单号,订单号的生成规则为departno+20200123+三位随机数+id,长度20位
					*先到orders表中查最后1条记录，获取其id，加1
					*如果orders表中是空的，
					*/		
				    var date = new Date();
					var rq = date.toJSON().substr(0, 11).replace(/[-T]/g, '');        
						
					var SMax=10000
					var sj = String(Math.ceil(Math.random() * SMax));				


					var result = '';
					for(var i=0;i<4;i++){
					  var ranNum = Math.ceil(Math.random() * 25); //生成一个0到25的数字
					  //大写字母'A'的ASCII是65,A~Z的ASCII码就是65 + 0~25;然后调用String.fromCharCode()传入ASCII值返回相应的字符并push进数组里
					  result=result+String.fromCharCode(65+ranNum);
					}										
			
				    var orderno = result + rq + '-'+sj
					Ext.getCmp('orderno').setValue(orderno);
					var record = Ext.create('detailmodel',{
						orderno:orderno,
						itemno:'',
						color:'',
						size:'',
						num:'',
						price:''
					});
					store.insert(0,record);
				}
				
				//保存订单数据
				function save(){
					//必须先获取主表数据oValues
					var oValues = form.getForm().getValues();
					console.log(oValues);
					 delete oValues.userno;
					// delete oValues.userpwdinput-inputEl;
					var lstRecord = [];
					var records = store.getModifiedRecords();
					var records_del = store.getRemovedRecords();
					for (var index=0;index<records.length;index++){
						record = records[index];
						record.data.qystatus = 'modi';    //添加修改标志
						lstRecord.push(record.data);
					}
					for (var index=0;index<records_del.length;index++){
						record = records_del[index];
						record.data.qystatus = 'del';  //添加删除编制
						lstRecord.push(record.data);
					}
					//这里是关联表,不是父子表,把data设为空数组,用lstRecord作为想保存的数据
					var OBJ = {
		                data:oValues,   //单头数据
		                rows:lstRecord  //单身数据
		            };
					console.log('ajax数据',JSON.stringify(OBJ))
					
					console.log('OBJ数据:',JSON.stringify(OBJ))
					//调用ajax进行保存
					Ext.Ajax.request({
						url:'ctl_orders.fsp?proc=saveorders',
						//把JS对象变为JSON字符串
						params:JSON.stringify(OBJ),						
						method:'POST',
						success:function(response,opts){
							console.log('saveorders:',response);
							var result = JSON.parse(response.responseText);
							if(result.errno==0){
								store.reload();    //刷新表格
								//MsgTip.msg('提示', '数据处理成功',true,1500);//默认1.5秒后自动隐藏 
							}else{
								Ext.Msg.alert('提示',result.errmsg);
							}
						}
					})					
				}
			
		
		})
		</script>
	</body>
</html>
